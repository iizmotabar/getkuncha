{"id":6703,"date":"2021-01-13T21:01:17","date_gmt":"2021-01-13T16:01:17","guid":{"rendered":"https:\/\/marketlytics.com\/?p=6703"},"modified":"2021-01-13T21:01:17","modified_gmt":"2021-01-13T16:01:17","slug":"integrating-gitlab-version-control-in-apps-script-via-google-cloud-function","status":"publish","type":"post","link":"https:\/\/marketlytics.com\/blog\/integrating-gitlab-version-control-in-apps-script-via-google-cloud-function\/","title":{"rendered":"Integrating GitLab Version Control in Apps Script Via Google Cloud Function"},"content":{"rendered":"\n<p>Google\u2019s ecosystem is incredibly widespread, from its productivity suite like Google Docs to the powerful Google Compute Engine platform. We are big fans of Google\u2019s ecosystem and have built our work around Google\u2019s set of tools.<\/p>\n\n\n\n<p>Google may be a little late to the productivity suite party but it has managed to build a solid product in the form of Google Sheets, thanks to its seamless collaborative features and incredibly powerful scripting abilities. This is possible thanks to the Google Apps Script platform, a rapid application development platform that makes it fast and easy to create business applications that integrate with different services.<\/p>\n\n\n\n<p>Most of our project management tools are built inside Google Sheets using Google Apps Script. One issue we have found with Apps Script is the ability to integrate it with a proper code versioning tool. GitLab is our preferred choice and we wanted to be able to commit changes directly to our code repository. Thus, we set our brains to work and came up with a quick solution to use a Google Cloud Function to integrate Apps Script with GitLab.<\/p>\n\n\n\n<h1 class=\"wp-block-heading\"><strong>Goal<\/strong><\/h1>\n\n\n\n<ul><li>Ability to commit changes to GitLab project directly from Google Apps Script<\/li><li>Get notifications on Slack for all successful commits<\/li><\/ul>\n\n\n\n<h1 class=\"wp-block-heading\"><strong>How To Use<\/strong><\/h1>\n\n\n\n<ol><li>Open your Apps Script project.<\/li><li>Paste the following code excerpt anywhere in the script.<\/li><\/ol>\n\n\n\n<figure class=\"wp-block-table aligncenter\"><table><tbody><tr><td>function commit() {&nbsp;&nbsp;<br>var commit_message = &#8220;apps script commit&#8221;&nbsp; &nbsp;\/\/the commit message&nbsp;&nbsp;<br>var&nbsp;function_url =&nbsp;&#8220;&#8221;&nbsp;\/\/The Trigger URL of the Cloud Function<br>var url = function_url+&#8221;script_id=&#8221;+ScriptApp.getScriptId()+&#8221;&amp;message=&#8221;+commit_message;<br>var response = UrlFetchApp.fetch(url);<br>Logger.log(response);&nbsp;&nbsp;}<\/td><\/tr><\/tbody><\/table><\/figure>\n\n\n\n<ol start=\"3\"><li>Execute the <strong>commit <\/strong>function to make a commit in the master branch.<\/li><\/ol>\n\n\n\n<p>It will create a <strong>scripts <\/strong>folder with all the scripts and the manifest from your Apps Script project. Any subsequent commits will update the folder with changes, as per the version control process.<\/p>\n\n\n\n<p>By default, it will use the <strong>repository name <\/strong>and the <strong>access token <\/strong>that have been stored in Google Cloud Storage and can be configured by editing the <strong>gitlab_credentials.json <\/strong>file.<\/p>\n\n\n\n<h1 class=\"wp-block-heading\"><strong>Workflow<\/strong><\/h1>\n\n\n\n<ul><li><strong>Apps Script<\/strong><ul><li>Executing the commit function creates a REST GET request with the Script ID of the project and the provided commit message<\/li><li>Calls the Google Cloud Function using the Trigger URL, providing it with the commit message and script id variables<\/li><li>Prints the result (commit diff) in the log<\/li><\/ul><\/li><li><strong>Cloud Function<\/strong><ul><li>Retrieves Google Credentials from Cloud Storage<\/li><li>Uses Google Credentials and Apps Script ID to retrieve project script files and manifest from Apps Script project<\/li><li>Retrieves Gitlab Credentials from Cloud Storage<\/li><li>Establishes connectivity with Gitlab and pulls the list of existing files<\/li><li>Starts creating a JSON commit object with the following file actions<ul><li><strong>Create <\/strong>action for newly created files<\/li><li><strong>Update <\/strong>action for already existing files<\/li><li><strong>Delete <\/strong>action for existing files that have been removed in the new request<\/li><\/ul><\/li><li>Sends a POST request to GitLab with the created JSON object<\/li><li>Retrieves the <em>diff <\/em>of the commit<\/li><li>Sends a new request to send to Slack using a webhook with the commit status, including the script URL and the GitLab commit URL (Optional)<\/li><li>Returns the result <em>commit diff <\/em>to the Apps Script project<\/li><\/ul><\/li><\/ul>\n\n\n\n<h1 class=\"wp-block-heading\"><strong>Deployment&nbsp;<\/strong><\/h1>\n\n\n\n<h2 class=\"wp-block-heading\"><strong>Getting Credentials<\/strong><\/h2>\n\n\n\n<p>To implement this, you will need two sets of credentials. Google Credentials that allow your script to access your Apps Script project and GitLab credentials that allow your script to commit to your GitLab repository.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\"><strong>Getting Credentials to Authenticate with Apps Script<\/strong><\/h3>\n\n\n\n<p>Enable the Apps Script API for your project by going to<a href=\"https:\/\/script.google.com\/home\/usersettings\" target=\"_blank\" rel=\"noreferrer noopener\"> Script Settings<\/a>.<\/p>\n\n\n\n<figure class=\"wp-block-image\"><img decoding=\"async\" src=\"https:\/\/lh6.googleusercontent.com\/KhF40vfw6N_gHUhqUJyS_f3utLdR4_Zvky-e7v3EJk7WG98Q2QjYrVA-0psp27OCCUkb8tRRFR6lv480qymVPXKWZdBNc61mc3K4to8-6lb_rGyPqhy6A7plZK_FuQ\" alt=\"\"\/><\/figure>\n\n\n\n<p>Open <a href=\"https:\/\/developers.google.com\/apps-script\/api\/quickstart\/python\" target=\"_blank\" rel=\"noreferrer noopener\"><strong>Google\u2019s Quickstart guide for Python<\/strong><\/a><strong>&nbsp;<\/strong>and execute <strong>Step 1 <\/strong>to download the Client Configuration File. Save it somewhere safe for now.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\"><strong>Getting Credentials to Authenticate with GitLab<\/strong><\/h3>\n\n\n\n<p>GitLab allows you to create a Personal Access token that you can use to perform changes to your repository using a scripting tool. Here is how you can create one,<br><\/p>\n\n\n\n<ol><li>Sign in to GitLab.<\/li><li>In the upper-right corner, click your avatar and select <strong>Settings<\/strong>.<\/li><li>On the <strong>User Settings<\/strong> menu, select <strong>Access Tokens<\/strong>.<\/li><li>Choose a name and optional expiry date for the token.<\/li><li>Choose the <a href=\"https:\/\/docs.gitlab.com\/ee\/user\/profile\/personal_access_tokens.html#limiting-scopes-of-a-personal-access-token\" target=\"_blank\" rel=\"noreferrer noopener\">desired scopes<\/a>. For our use, we require read as well as write access to allow us to execute commits so we are going to select all scopes.<\/li><li>Click the <strong>Create personal access token<\/strong> button.<\/li><li>Save the personal access token somewhere safe. If you navigate away or refresh your page, and you did not save the token, you must create a new one.<\/li><\/ol>\n\n\n\n<p>Now create a file in the following format, with the token in the <strong>token<\/strong> field and the name of the repositories you want to allow your function to commit to as a list in the <strong>repo<\/strong> field. This functionality has been added as an additional security feature to prevent accidental changes to other repositories.<\/p>\n\n\n\n<figure class=\"wp-block-table aligncenter\"><table><tbody><tr><td>{&#8220;token&#8221;:&#8221;**************&#8221;,&#8221;repo_list&#8221;:[&#8220;apps-script-project&#8221;]}<\/td><\/tr><\/tbody><\/table><\/figure>\n\n\n\n<p><br>Save it in JSON format. For e.g. gitlab_credentials.json.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\"><strong>Slack Credentials&nbsp;<\/strong><\/h3>\n\n\n\n<p>One additional functionality that we have built-in this code is the ability to generate Slack alerts to notify in case of any error faced. You can choose to remove this functionality by simply commenting out the lines from <strong>236-252<\/strong>.<\/p>\n\n\n\n<p>If you want to use it, you can create an <a href=\"https:\/\/api.slack.com\/messaging\/webhooks#create_a_webhook\" target=\"_blank\" rel=\"noreferrer noopener\">incoming Slack Webhook<\/a>&nbsp;and store the URL in the following format on the same Cloud Storage bucket being used for the credentials files.<\/p>\n\n\n\n<figure class=\"wp-block-table aligncenter\"><table><tbody><tr><td>{&#8220;url&#8221;:&#8221;&#8221;}<\/td><\/tr><\/tbody><\/table><\/figure>\n\n\n\n<h2 class=\"wp-block-heading\"><strong>Storing Credentials<\/strong><\/h2>\n\n\n\n<p>Now, you should have three files,<\/p>\n\n\n\n<ul><li><strong>credentials.json<\/strong><\/li><li><strong>gitlab_credentials.json<\/strong><\/li><li><strong>slack_webhook.json (Optional)<\/strong><\/li><\/ul>\n\n\n\n<p>We are going to store this file on Google Cloud Storage, which&nbsp;is a RESTful online file storage web service for storing and accessing data on Google Cloud Platform infrastructure. It allows us to safely store and access credentials without exposing them in our code files.<br><\/p>\n\n\n\n<p>Visit <a href=\"https:\/\/console.cloud.google.com\/storage\/browser\" target=\"_blank\" rel=\"noreferrer noopener\"><strong>Google Cloud Storage Console<\/strong><\/a><strong> <\/strong>and create a new bucket and store this file there. Copy the <strong>Path<\/strong> for each file. You are going to configure these in the Cloud Function section later on.<\/p>\n\n\n\n<h2 class=\"wp-block-heading\"><strong>Google Cloud Function<\/strong><\/h2>\n\n\n\n<h3 class=\"wp-block-heading\"><strong>Creating Function<\/strong><\/h3>\n\n\n\n<ol><li>Go to the <a href=\"https:\/\/console.cloud.google.com\/functions\/add?\" target=\"_blank\" rel=\"noreferrer noopener\"><strong>Create a<\/strong> <strong>Google Cloud Function <\/strong>option menu<\/a>.<\/li><li>Enter the function <strong>name <\/strong>and preferred <strong>region<\/strong>.<\/li><li>For <strong>Trigger <\/strong>type, choose <strong>HTTP<\/strong>.<\/li><li>For <strong>Authentication<\/strong>, choose <strong>Allow unauthenticated&nbsp;access<\/strong>. For more security, you can also choose <strong>Require authentication <\/strong>but this will restrict your function in terms of accessibility. We suggest going with Allow unauthenticated access for testing purposes and changing it later to restricted.<\/li><li>Click on <strong>Advanced<\/strong>&nbsp;and specify the configurations,<ol><li><strong>Memory Allocated: <\/strong>512 MB (Recommended)<\/li><li><strong>Timeout: <\/strong>540 seconds (Recommended)<\/li><\/ol><\/li><\/ol>\n\n\n\n<ol start=\"6\"><li>Click on <strong>Variables, Networking and Advanced Settings <\/strong>to reveal more options. Here, you will create&nbsp;<strong>runtime environment variables <\/strong>which are variables accessible to your function using the <strong>os <\/strong>library at runtime. We are going to use the components of code that need to be changed i.e. the Cloud Storage paths for our credential files as well as the name of our project,<\/li><\/ol>\n\n\n\n<figure class=\"wp-block-table aligncenter\"><table><tbody><tr><td><strong>gitlab_credentials:<\/strong>cloud_storage_path\/gitlab_credentials.json<br><strong>google_credentials:<\/strong>cloud_storage_path\/google_credentials.json<br><strong>slack_webhook: <\/strong>cloud_storage_path\/slack_webhook.json<br><strong>scripts_folder:<\/strong> scripts\/ <br><strong>project_name:<\/strong> google-cloud-project-name<\/td><\/tr><\/tbody><\/table><\/figure>\n\n\n\n<ol start=\"7\"><li>Once you are done, click on <strong>NEXT<\/strong>.<\/li><\/ol>\n\n\n\n<p>This will create your function and take you to the <strong>Source <\/strong>page where you can edit and add the code. There are two essential files you need to upload here,<\/p>\n\n\n\n<ul><li><strong>main.py &#8211;<\/strong>&nbsp;Contains the Python script.<\/li><li><strong>requirements.txt &#8211; <\/strong>Contains the packages required by the main.py script.<\/li><\/ul>\n\n\n\n<p>Both of these files are provided in the following <a href=\"https:\/\/gitlab.com\/-\/snippets\/2059496\">code snippet<\/a>.<\/p>\n","protected":false},"excerpt":{"rendered":"<p>Google\u2019s ecosystem is incredibly widespread, from its productivity suite like Google Docs to the powerful Google Compute Engine platform. We are big fans of Google\u2019s ecosystem and have built our work around Google\u2019s set of tools. Google may be a little late to the productivity suite party but it has managed to build a solid [&hellip;]<\/p>\n","protected":false},"author":5,"featured_media":6741,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"content-type":"","footnotes":""},"categories":[3],"tags":[],"acf":[],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/6703"}],"collection":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/users\/5"}],"replies":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/comments?post=6703"}],"version-history":[{"count":0,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/6703\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/media\/6741"}],"wp:attachment":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/media?parent=6703"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/categories?post=6703"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/tags?post=6703"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}