{"id":122,"date":"2013-03-25T23:08:15","date_gmt":"2013-03-25T18:08:15","guid":{"rendered":"http:\/\/18.139.242.7\/2013\/03\/25\/building-datalayer-within-google-tag-manager-interface-using-jquery-javascript\/"},"modified":"2013-03-25T23:08:15","modified_gmt":"2013-03-25T18:08:15","slug":"building-datalayer-within-google-tag-manager-interface-using-jquery-javascript","status":"publish","type":"post","link":"https:\/\/marketlytics.com\/blog\/building-datalayer-within-google-tag-manager-interface-using-jquery-javascript\/","title":{"rendered":"Building the Datalayer within GTM Interface using jquery and javascript"},"content":{"rendered":"<p>Implementing GTM has been a huge time saver in terms of getting new tags live, making sure you are sending all the useful events to tag manager is crucial to making it work otherwise you&#8217;ll be going back to the old cycle of asking for code changes every time you want to measure something new. To avoid this gtm recommends building comprehensive dataLayer by setting up js objects on each page you want to send data from.<\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">dataLayer<\/span> <span class=\"cm-operator\">=<\/span> [{<span class=\"cm-string cm-property\">'key'<\/span>:<span class=\"cm-string\">'value'<\/span>, <span class=\"cm-string cm-property\">'company'<\/span>:<span class=\"cm-string\">'marketlytics'<\/span>}];<\/pre>\n<p>And triggering dataLayer events on important actions:<\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">dataLayer<\/span>.<span class=\"cm-property\">push<\/span>({ <span class=\"cm-string cm-property\">'scroll'<\/span>:<span class=\"cm-string\">'25% done'<\/span>, <span class=\"cm-string cm-property\">'event'<\/span>:<span class=\"cm-string\">'reading blog'<\/span> });<\/pre>\n<p>But this is still a bit tedious and it happens every so often that you forget to track an action, this got me thinking since each gtm tag is conceptually similar to a script tag why cant we add js\/jquery listeners for different actions within the tag manager web interface especially since most of what we need to measure is already present on the page in one form or another.<\/p>\n<p>Well you can all you need to do is create a custom html tag and add your js script to it.<\/p>\n<p><em>this post assumes knowledge of tag manager and mixes terms fairly frequently, checkout the <a target=\"_blank\" href=\"https:\/\/marketlytics.com\/blog\/an-intro-to-google-tag-manager-and-its-feature-usage\" rel=\"noopener noreferrer\">intro to gtm<\/a> first&#8230;<\/em><\/p>\n<p>The first issue that crops up is gtm is async so it doesn&#8217;t wait for the page to load before triggering tags. If we are using jquery to add triggers to page elements its important that 1) jquery library has loaded 2) the element we want has already been rendered<\/p>\n<h2>hello gtm.dom<\/h2>\n<p>The <a target=\"_blank\" href=\"https:\/\/support.google.com\/tagmanager\/answer\/2644396?hl=en\" rel=\"noopener noreferrer\">documentation<\/a> mentions a default gtm event gtm.dom which is fired when dom is ready. So all we need is a rule to trigger our custom html tag with jquery code based on this rule.<\/p>\n<p><strong>rule: event equals gtm.dom<\/strong><\/p>\n<p>Now our tag will be loaded once the dom is ready. The jquery listener will be set on the action we define. And it will be triggered when the action takes place.<\/p>\n<p>ps. you can just fire the actual script you want at gtm.dom and send data(dont forget to make the rule a bit more specific and define additional conditions, universal rules get messy). For example send data to GA:<\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">jQuery<\/span>(<span class=\"cm-string\">'#button'<\/span>).<span class=\"cm-property\">click<\/span>(<span class=\"cm-keyword\">function<\/span>(){ <span class=\"cm-string\">'_gaq.push(['<\/span><span class=\"cm-variable\">_trackEvent<\/span><span class=\"cm-string\">', '<\/span><span class=\"cm-variable\">homepage<\/span><span class=\"cm-string\">', '<\/span><span class=\"cm-variable\">click<\/span><span class=\"cm-string\">', '<\/span><span class=\"cm-variable\">button<\/span><span class=\"cm-string\">']); });<\/span><\/pre>\n<p>but that doesn&#8217;t actually build a dataLayer and means our actions aren&#8217;t reusable else where. So that&#8217;s no fun we want to benefit from the abstraction dataLayer offers.<\/p>\n<h2>building event chains<\/h2>\n<p>Instead what we want to do is build a chain where the first level tag (let&#8217;s call it data tag) pushes key values to dataLayer and the next level of tags (send tag) are triggered based on this push and deliver data to platform of choice..<\/p>\n<p>To do this let&#8217;s change up our tag to<\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">jQuery<\/span>(<span class=\"cm-string\">'#button'<\/span>).<span class=\"cm-property\">click<\/span>(<span class=\"cm-keyword\">function<\/span>(){ <span class=\"cm-string\">'dataLayer.push({ '<\/span><span class=\"cm-variable\">category<\/span><span class=\"cm-string\">':'<\/span><span class=\"cm-variable\">homepage<\/span><span class=\"cm-string\">', \/\/ or use a macro to get url '<\/span><span class=\"cm-variable\">action<\/span><span class=\"cm-string\">':'<\/span><span class=\"cm-variable\">click<\/span><span class=\"cm-string\">', '<\/span><span class=\"cm-variable\">label<\/span><span class=\"cm-string\">':'<\/span><span class=\"cm-variable\">button<\/span><span class=\"cm-string\">', '<\/span><span class=\"cm-variable\">event<\/span><span class=\"cm-string\">':'<\/span><span class=\"cm-variable\">click<\/span><span class=\"cm-operator\">-<\/span><span class=\"cm-variable\">event<\/span><span class=\"cm-string\">'}); });<\/span>\n\n<\/pre>\n<p>Next we would build a tag that is fired on the rule <strong>event equals click-event<\/strong><\/p>\n<p>For example based on this rule we can trigger a Google Analytics Event tag. Or a new universal analytics event hit or both \ud83d\ude42<\/p>\n<p>ps. at the same time we can also use macros within the data level tags or send level tags, thus making the code even more reusable.<\/p>\n<p>So let&#8217;s review what we did, we created a data tag that is fired when dom is ready. This could be a jquery or js script which would listen for an action on the page and once the action happens this pushes information. Then based on the specified event a send tag \/ set of send tags are triggered sending info to multiple platforms.<\/p>\n<p>ps. the chains are also very helpful if you just want to move your existing ga scripts to gtm. For example I am a big fan of scroll tracking on long pages and was using <a target=\"_blank\" href=\"https:\/\/robflaherty.github.com\/jquery-scrolldepth\/\" rel=\"noopener noreferrer\">this script by Rob<\/a><\/p>\n<p>When I got around to moving marketlytics.com GA tags to gtm I thought transferring this would be good to have all my tags in one place not mention have benefits of async loading. To do it I just created a custom html tag for the script and loaded it on gtm.dom then added a dataLayer event at the end of script to inform when the was finished loading. And finally setup a second gtm tag to initiate scroll tracking.<\/p>\n<style>\n.newsletter-form {\n  position: relative;\n  height: 200px;\n  width: 100%;\n}\n.newsletter-signup img { \n  width: 100%;\n}<\/p>\n<p>.thankyou {\n  position: relative;\n  top: -110px;\n  left: 10px;\n  display: none;\n}<\/p>\n<p>.thankyou p {\n  color: #7f8c8d;\n  font-weight: bold;\n  font-size: 8px;\n}<\/p>\n<p>  .thankyou a:link {\n    color: #e74c3c;\n    font-style: italic;\n  }<\/p>\n<p>form {\n  position: absolute;\n  margin-top: -75px;\n  left: 30px;\n  width: 60%;\n  }\n  form input {\n    width: 45%;\n    height: 30px;\n    border-radius: 3px;\n    border: 1px solid #16a085;\n    padding: 0 20px;\n  }<\/p>\n<p>  form button {\n    padding: 5px 8px;\n    background-color: #e74c30;\n    color: #fff;\n    font-weight: bold;\n    font-family: sans-serif;\n    font-size: 16px;\n    border-radius: 5px;\n  }<\/p>\n<p>  @media(max-width: 768px) {\n    form {\n      left: 20px;\n    }<\/p>\n<p>    form input {\n      width: 60%;\n        padding: 0 10px;\n    }\n  }<\/p>\n<p>  @media(max-width: 690px) {\n    form {\n      left: 20px;\n    }\n  }<\/p>\n<p>  @media(max-width: 650px) {\n    form {\n      left: 20px;\n    }\n  }<\/p>\n<p>  @media(max-width: 600px) {\n    form {\n      left: 20px;\n    }\n  }<\/p>\n<p>  @media(max-width: 550px) {\n    form {\n      left: 20px;\n        margin-top: -60px;\n    }<\/p>\n<p>    form input {\n      width: 50%;\n        height: 26px;\n    }<\/p>\n<p>    form button {\n      padding: 5px 5px;\n        font-size: 12px;\n    }\n  }<\/p>\n<p>  @media(max-width: 500px) {\n    form {\n      left: 20px;\n      margin-top: -65px;\n  }\n  }<\/p>\n<p>  @media(max-width: 450px) {\n    form {\n      left: 20px;\n  }\n  }<\/p>\n<p>\/*@media screen and (max-width: 650px) and (min-width: 480px) {\n  form {\n    left: 180px;\n  } \n  form input {\n    width: 40%;\n    height: 20px;\n    border-radius: 3px;\n    border: 1px solid #16a085;\n  }\n  form button {\n    padding: 5px 3px;\n    background-color: #16a085;\n    color: #fff;\n    font-weight: bold;\n    font-family: sans-serif;\n    font-size: 10px;\n    border-radius: 5px;\n  }\n}*\/\n<\/style>\n<div class=\"newsletter-signup\">\n  <img decoding=\"async\" src=\"https:\/\/marketlytics.com\/wp-content\/uploads\/2016\/11\/newslettersignup.png\"\/><\/p>\n<form id=\"newsletter-signup\" name=\"newsletter\" action=\"#\" method=\"post\" onsubmit=\"toggle(); return false;\">\n      <input type=\"email\" name=\"email\" placeholder=\"enter email\" required><br \/>\n    <button type=\"submit\">Subscribe<\/button><br \/>\n  <\/form>\n<div class=\"thankyou\" id=\"thanks\">\n<p>Thank you for joining our monthly newsletter<br \/>\n    Follow us on <a href=\"https:\/\/twitter.com\/MarketLytics\" target=\"_blank\" rel=\"noopener noreferrer\">Twitter<\/a><\/p>\n<\/p><\/div>\n<\/div>\n<p><script>\n    function toggle() {<\/p>\n<p>          $('#newsletter-signup').fadeOut(1000);\n          $('#thanks').fadeIn(1500);<\/p>\n<p>    };\n<\/script><\/p>\n","protected":false},"excerpt":{"rendered":"<p><span style=\"font-size:13px\">Google Tag Manager has hidden super powers when mixed with a bit of jQuery &amp; javascript allows us to do (most of) the tracking directly within its interface. <\/span><\/p>\n","protected":false},"author":5,"featured_media":183,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"content-type":"","footnotes":""},"categories":[3],"tags":[40,66,68,78,81,85,114],"acf":[],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/122"}],"collection":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/users\/5"}],"replies":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/comments?post=122"}],"version-history":[{"count":0,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/122\/revisions"}],"wp:featuredmedia":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/media\/183"}],"wp:attachment":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/media?parent=122"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/categories?post=122"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/tags?post=122"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}