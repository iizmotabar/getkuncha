{"id":175,"date":"2015-07-21T20:31:41","date_gmt":"2015-07-21T15:31:41","guid":{"rendered":"http:\/\/18.139.242.7\/2015\/07\/21\/implement-kissmetrics-using-google-tag-manager\/"},"modified":"2015-07-21T20:31:41","modified_gmt":"2015-07-21T15:31:41","slug":"implement-kissmetrics-using-google-tag-manager","status":"publish","type":"post","link":"https:\/\/marketlytics.com\/blog\/implement-kissmetrics-using-google-tag-manager\/","title":{"rendered":"Implementing KISSMetrics using Google Tag Manager"},"content":{"rendered":"<p>Google Tag manager has been commonly used as a tool for firing marketing tags and sending data to google analytics. And it has a lot of support out of the box to easily setup google analytics or fire conversion pixels. But its fundamental building block provides us the ease to build reusable templates that can send data to all types of analytics services including tools like kissmetrics, mixpanel, keenio, intercom.<\/p>\n<p>For building reusable tags, things that work best are those that don&#8217;t make any user facing changes to the page and are flexible enough to work asynchronously [i.e. data is not lost if the analytics library is not loaded. Instead it is maintained in a queue for sending it afterwards]<\/p>\n<p>With this in mind, I would like to share the battle tested implementation I have been using to send data to kissmetrics. This assumes a basic knowledge of gtm [tags, triggers, variables] and builds on this to chain things together. It&#8217;s also principally similar to what&#8217;s described in this post.<\/p>\n<h2>What we want to achieve:<\/h2>\n<ul>\n<li>to have tag templates that can be used to send any events and properties to KM<\/li>\n<li>to identify users connecting their anonymized IDs with real world identifiers.<\/li>\n<\/ul>\n<p>We want to achieve this by defining a standard template tag and sending any data received by it to Kissmetrics.<\/p>\n<h2>Requirements for Setup:<\/h2>\n<h3>Variables<\/h3>\n<p>We need to create 3 dataLayer variables: <em><strong>Variable type:<\/strong><\/em> dataLayer <em><strong>Variable Names:&nbsp;<\/strong><\/em>km_event, km_property, km_property_email<\/p>\n<p>Following is the image of creating dataLayer variable &nbsp;km_property.email. You will have to do the same for other two.<\/p>\n<div style=\"width: 1003px\" class=\"wp-caption alignnone\"><a href=\"https:\/\/marketlytics.com\/wp-content\/uploads\/2015\/12\/Google-Tag-Manager-2015-06-22-jqxw9.png\" ><img decoding=\"async\" src=\"https:\/\/marketlytics.com\/wp-content\/uploads\/2020\/03\/Google-Tag-Manager-2015-06-22-jqxw9.png\" alt=\"Google Tag Manager\"\/><\/a><p class=\"wp-caption-text\">Google Tag Manager<\/p><\/div>\n<h3>&nbsp;1. Kissmetrics &#8211; Tracking Code<\/h3>\n<p>This tag fires on each page and loads the KM tracking library. This would also do things like tracking the default visit event.<\/p>\n<h3>Tag Details<\/h3>\n<p><strong><em>Tag Name:<\/em><\/strong> Kissmetrics &#8211; Tracking Code <strong><em>Tag Type:<\/em><\/strong> Custom HTML <em><strong>Tag Content:<\/strong><\/em>Copy paste your tracking code from Kissmetrics <a href=\"https:\/\/app.kissmetrics.com\/settings\">settings page<\/a> to this tag. <strong><em>Trigger Rule:<\/em><\/strong><a href=\"https:\/\/take.ms\/1WugQ\">All pages<\/a><\/p>\n<blockquote>\n<p><strong>Note:<\/strong> Make sure this tag is set to fire first. Also give it the tag firing property of 1.<\/p>\n<\/blockquote>\n<h3>2. Kissmetrics &#8211; Record Event<\/h3>\n<p>This tag will provide a standard template for sending data to KM.<\/p>\n<p>Tag Details<\/p>\n<p><strong><em>Tag Name:<\/em><\/strong> Kissmetrics &#8211; Record Event <strong><em>Tag Type:<\/em><\/strong> Custom HTML<\/p>\n<p><strong><em>Tag Content: <\/em><\/strong><\/p>\n<pre class=\"source-code\"><span class=\"cm-operator\">&lt;<\/span><span class=\"cm-variable\">script<\/span><span class=\"cm-operator\">&gt;<\/span>\n    <span class=\"cm-keyword\">var<\/span> <span class=\"cm-variable\">_kmq<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-variable\">window<\/span>.<span class=\"cm-property\">_kmq<\/span> <span class=\"cm-operator\">||<\/span> [];\n \n   <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>(<span class=\"cm-keyword\">function<\/span>() {\n        <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>([<span class=\"cm-string\">'record'<\/span>,<span class=\"cm-string\">'{{km_event}}'<\/span>,{{<span class=\"cm-variable\">km_property<\/span>}}]);        \n \n        <span class=\"cm-comment\">\/\/ empty the km_property object so it can be reused for sending more events<\/span>\n        <span class=\"cm-variable\">dataLayer<\/span>.<span class=\"cm-property\">push<\/span>({\n            <span class=\"cm-string cm-property\">'km_property'<\/span>:{}\n        });\n \n        <span class=\"cm-comment\">\/\/ this script is used for identifying user if a valid email address is found.<\/span>\n        <span class=\"cm-keyword\">var<\/span> <span class=\"cm-def\">regEmail<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string-2\">\/^\\S+@\\S+\\.\\S+$\/<\/span>;\n        <span class=\"cm-keyword\">var<\/span> <span class=\"cm-def\">email<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string\">\"{{km_property_email}}\"<\/span>.<span class=\"cm-property\">replace<\/span>(<span class=\"cm-string-2\">\/ \/g<\/span>,<span class=\"cm-string\">''<\/span>);\n        <span class=\"cm-keyword\">if<\/span> (<span class=\"cm-variable-2\">email<\/span>.<span class=\"cm-property\">match<\/span>(<span class=\"cm-variable-2\">regEmail<\/span>) <span class=\"cm-operator\">!==<\/span> <span class=\"cm-atom\">null<\/span>){\n            <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>([<span class=\"cm-string\">'identify'<\/span>, <span class=\"cm-variable-2\">email<\/span>]);\n        }\n    });\n<span class=\"cm-operator\">&lt;<\/span><span class=\"cm-string-2\">\/script&gt;<\/span><\/pre>\n<p>\u00a0<\/p>\n<p><strong><em>Trigger Rule<\/em><\/strong>: event equals km_record<\/p>\n<h3>3. Kissmetrics &#8211; Set Property<\/h3>\n<p>This tag will provide a standard template for sending properties to KM.<\/p>\n<p>Tag Details<\/p>\n<p><strong><em>Tag Name<\/em><\/strong>: Kissmetrics &#8211; Set Property <em><strong>Tag Type:<\/strong><\/em> Custom HTML<\/p>\n<p><em><strong>Tag Content: <\/strong><\/em><\/p>\n<pre class=\"source-code\"><span class=\"cm-operator\">&lt;<\/span><span class=\"cm-variable\">script<\/span><span class=\"cm-operator\">&gt;<\/span>\n<span class=\"cm-keyword\">var<\/span> <span class=\"cm-variable\">_kmq<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-variable\">window<\/span>.<span class=\"cm-property\">_kmq<\/span> <span class=\"cm-operator\">||<\/span> [];\n<span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>(<span class=\"cm-keyword\">function<\/span>() {\n    <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>([<span class=\"cm-string\">'set'<\/span>, {{<span class=\"cm-variable\">km_property<\/span>}}]); \n \n    <span class=\"cm-comment\">\/\/ empty the km_property object so it can be reused for sending more events<\/span>\n    <span class=\"cm-variable\">dataLayer<\/span>.<span class=\"cm-property\">push<\/span>({\n       <span class=\"cm-string cm-property\">'km_property'<\/span>:{}\n    });\n \n    <span class=\"cm-comment\">\/\/ this script is used for identifying user if a valid email address is found.<\/span>\n    <span class=\"cm-keyword\">var<\/span> <span class=\"cm-def\">regEmail<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string-2\">\/^\\S+@\\S+\\.\\S+$\/<\/span>;\n    <span class=\"cm-keyword\">var<\/span> <span class=\"cm-def\">email<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string\">\"{{km_property_email}}\"<\/span>.<span class=\"cm-property\">replace<\/span>(<span class=\"cm-string-2\">\/ \/g<\/span>,<span class=\"cm-string\">''<\/span>);\n    <span class=\"cm-keyword\">if<\/span> (<span class=\"cm-variable-2\">email<\/span>.<span class=\"cm-property\">match<\/span>(<span class=\"cm-variable-2\">regEmail<\/span>) <span class=\"cm-operator\">!==<\/span> <span class=\"cm-atom\">null<\/span>){\n        <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>([<span class=\"cm-string\">'identify'<\/span>, <span class=\"cm-variable-2\">email<\/span>]);\n    }\n });\n<span class=\"cm-operator\">&lt;<\/span><span class=\"cm-string-2\">\/script&gt;<\/span><\/pre>\n<p><em><strong>Trigger Rule:<\/strong><\/em> event equals km_set<\/p>\n<h3>4. Template for Sending Event to KM<\/h3>\n<p>Now that we have setup the template tags, we can send any data to Kissmetrics tags using the datalayer. Next the templates take care of formatting it to the kissmetrics expected format. Lets send an event on Call to Action Click<\/p>\n<p>Tag Details<\/p>\n<p><strong>Tag Name<\/strong>: Kissmetrics &#8211; Record Buy Now <strong><em>Tag Type<\/em><\/strong>: Custom HTML<\/p>\n<p><strong><em>Tag Content:<\/em><\/strong><\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">dataLayer<\/span>.<span class=\"cm-property\">push<\/span>({\n    <span class=\"cm-string cm-property\">'event'<\/span>:<span class=\"cm-string\">'km_record'<\/span>,\n    <span class=\"cm-string cm-property\">'km_event'<\/span>:<span class=\"cm-string\">'Buy Now Clicked'<\/span>,\n    <span class=\"cm-string cm-property\">'km_property'<\/span>:{\n        <span class=\"cm-string cm-property\">'url'<\/span>:<span class=\"cm-string\">'{{page path}}'<\/span>,\n        <span class=\"cm-string cm-property\">'button text'<\/span>:<span class=\"cm-string\">'{{element text}}'<\/span>\n    }\n});<\/pre>\n<p>\u00a0<\/p>\n<p><strong><em>Trigger Rule:<\/em><\/strong> event equals gtm.click, element ID equals buy-now<\/p>\n<p>Code Explanation<\/p>\n<p>Lets go through the code line by line to see what&#8217;s happening:<\/p>\n<ul>\n<li>dataLayer.push -&gt; It is a gtm standard method for transporting data<\/li>\n<li>&#8216;event&#8217;:&#8217;km_record&#8217; -&gt; This is the trigger rule we used for event tag. As soon as gtm sees this, KM record event template will be triggered.<\/li>\n<li>&#8216;km_event&#8217;:&#8217;Buy Now Clicked&#8217; -&gt; This is a variable. Anything sent with this will show up as event name in KM<\/li>\n<li>&#8216;km_property&#8217;: -&gt; This is mapped to the property object km expects. Any key\/values passed within it will be sent to KM as properties.<\/li>\n<\/ul>\n<pre class=\"source-code\"><span class=\"cm-string\">'km_property'<\/span>:{ <span class=\"cm-string\">'visit date'<\/span>:<span class=\"cm-string\">'{{current date}}'<\/span>,     <span class=\"cm-string\">'plan'<\/span>:<span class=\"cm-string\">'pro'<\/span> }<\/pre>\n<p>\u00a0<\/p>\n<h3>5. Template for Sending Properties to KM<\/h3>\n<p>Properties are used to update attributes about users. They only contain the property object.<\/p>\n<p><strong><em>Tag Content:<\/em><\/strong><\/p>\n<pre class=\"source-code\"><span class=\"cm-variable\">dataLayer<\/span>.<span class=\"cm-property\">push<\/span>({ <span class=\"cm-string cm-property\">'event'<\/span>:<span class=\"cm-string\">'km_set'<\/span>, <span class=\"cm-string cm-property\">'km_property'<\/span>:{ <span class=\"cm-string cm-property\">'sales page visited date'<\/span>:<span class=\"cm-string\">'1-06-2015'<\/span>, <span class=\"cm-string cm-property\">'sales page name'<\/span>:<span class=\"cm-string\">'father day discount'<\/span> } });<\/pre>\n<h3>6. Identifying Users<\/h3>\n<p>With kissmetrics comes the ability to tie the randomized id. This id is assigned to user&#8217;s known id, like their email address (recommended) or internal id. *<em>Identification with email is encouraged as frequently and soon as possible. *<\/em> To make it convenient and easy we&#8217;ve done two things. First, we&#8217;ve defined a special key in km_property email that once passed is assigned to variable km_property_email. This automatically identifies the user when detected with any event or property. Second, using the code block<\/p>\n<pre class=\"source-code\"><span class=\"cm-comment\">\/\/ this script is used for identifying user if a valid email address is found. <\/span>\n<span class=\"cm-keyword\">var<\/span> <span class=\"cm-variable\">regEmail<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string-2\">\/^\\S+@\\S+\\.\\S+$\/<\/span>; <span class=\"cm-keyword\">var<\/span> <span class=\"cm-variable\">email<\/span> <span class=\"cm-operator\">=<\/span> <span class=\"cm-string\">\"{{km_property_email}}\"<\/span>.<span class=\"cm-property\">replace<\/span>(<span class=\"cm-string-2\">\/ \/g<\/span>,<span class=\"cm-string\">''<\/span>); <span class=\"cm-keyword\">if<\/span> (<span class=\"cm-variable\">email<\/span>.<span class=\"cm-property\">match<\/span>(<span class=\"cm-variable\">regEmail<\/span>) <span class=\"cm-operator\">!==<\/span> <span class=\"cm-atom\">null<\/span>){ <span class=\"cm-variable\">_kmq<\/span>.<span class=\"cm-property\">push<\/span>([<span class=\"cm-string\">'identify'<\/span>, <span class=\"cm-variable\">email<\/span>]); }<\/pre>\n<p>we tried to liberally match for an email address before sending an identify call to the user.<\/p>\n<p>And there you have it! An end to end template that allows you to easily send data to KM while relying on the building blocks of Google Tag Manager. It not only offers to speed up the process but also makes it more maintainable.<\/p>\n<p>I&#8217;d be keen to hear about any improvements or thoughts you would like to share after trying this implementation. Look forward to hearing about your cool implementations. Any other tweaks share in comments!<\/p>\n<p><em>with thanks to fine combed editing by Zainab<\/em>.<\/p>\n<p><em>We have setup a preconfigured container for the above, you can view it from our tools section at <\/em><a target=\"_blank\" href=\"https:\/\/marketlytics.com\/tools\/google-tagmanager-kissmetrics-setup\" rel=\"noopener noreferrer\"><em>Kissmetrics Reusable Container<\/em><\/a><\/p>\n","protected":false},"excerpt":{"rendered":"<p><span style=\"font-size:13px\">A step by step guide for implementing Kissmetrics using Google Tag Manager. A ready to use template to get you started also included.<\/span><\/p>\n","protected":false},"author":5,"featured_media":0,"comment_status":"open","ping_status":"open","sticky":false,"template":"","format":"standard","meta":{"content-type":"","footnotes":""},"categories":[3,7],"tags":[66,68,72,82,85],"acf":[],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/175"}],"collection":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/users\/5"}],"replies":[{"embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/comments?post=175"}],"version-history":[{"count":0,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/posts\/175\/revisions"}],"wp:attachment":[{"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/media?parent=175"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/categories?post=175"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/marketlytics.com\/wp-json\/wp\/v2\/tags?post=175"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}